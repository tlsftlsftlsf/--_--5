<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>WebDAV Client Test Suite</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; line-height: 1.6; }
        .test-group { margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; padding: 15px; }
        .test-group h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .test-case { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; display: flex; justify-content: space-between; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        .summary { margin-top: 20px; padding: 20px; background: #e9ecef; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>ğŸ› ï¸ WebDAV Client å•å…ƒæµ‹è¯•</h1>
    <div id="test-results"></div>
    <div id="summary" class="summary"></div>

    <script>
        // æ¨¡æ‹Ÿç¯å¢ƒ
        const localStorageMock = (function() {
            let store = {};
            return {
                getItem: function(key) { return store[key] || null; },
                setItem: function(key, value) { store[key] = value.toString(); },
                clear: function() { store = {}; }
            };
        })();

        Object.defineProperty(window, 'localStorage', { value: localStorageMock });

        // æ¨¡æ‹Ÿ UI å…ƒç´ 
        document.body.insertAdjacentHTML('beforeend', `
            <div id="hidden-ui" style="display:none">
                <input id="davServerUrl" value="https://dav.jianguoyun.com/dav/">
                <input id="davProxyUrl" value="">
                <input id="davUsername" value="test@example.com">
                <input id="davPassword" value="password123">
                <input type="checkbox" id="davAutoSync">
                <select id="davConflictStrategy"><option value="newest-wins">æœ€æ–°æ•°æ®ä¼˜å…ˆ</option></select>
                <div id="davConnectionStatus"><span class="sync-text"></span></div>
                <div id="mainSyncIcon"></div><div id="mainSyncText"></div><div id="mainSyncStatus"></div><div id="lastSyncTime"></div>
            </div>
        `);

        // æ¨¡æ‹Ÿ showToast
        window.showToast = console.log;
        window.closeWebDAVConfig = () => {};

        // å¤åˆ¶ NutcloudWebDAVClient ç±»å®šä¹‰ (ä»ä¸»æ–‡ä»¶)
        class NutcloudWebDAVClient {
            constructor() {
                this.config = this.loadConfig();
                this.isSyncing = false;
            }

            loadConfig() {
                const stored = localStorage.getItem('webdav_config');
                return stored ? JSON.parse(stored) : {
                    serverUrl: 'https://dav.jianguoyun.com/dav/',
                    proxyUrl: '',
                    username: '',
                    password: '',
                    autoSync: false,
                    conflictStrategy: 'newest-wins'
                };
            }

            saveConfig() {
                const serverUrl = document.getElementById('davServerUrl').value.trim();
                const proxyUrl = document.getElementById('davProxyUrl').value.trim();
                const username = document.getElementById('davUsername').value.trim();
                const password = document.getElementById('davPassword').value.trim();
                const autoSync = document.getElementById('davAutoSync').checked;
                const conflictStrategy = document.getElementById('davConflictStrategy').value;

                const encryptedPassword = btoa(password);

                this.config = {
                    serverUrl,
                    proxyUrl,
                    username,
                    password: encryptedPassword,
                    autoSync,
                    conflictStrategy
                };

                localStorage.setItem('webdav_config', JSON.stringify(this.config));
            }

            getAuthHeader() {
                try {
                    const password = atob(this.config.password);
                    return 'Basic ' + btoa(this.config.username + ':' + password);
                } catch (e) {
                    return '';
                }
            }

            getRequestUrl(path = '') {
                if (path && !path.startsWith('/')) path = '/' + path;
                
                if (this.config.proxyUrl) {
                    let proxyUrl = this.config.proxyUrl;
                    if (proxyUrl.endsWith('/')) proxyUrl = proxyUrl.slice(0, -1);
                    return proxyUrl + path;
                }
                
                let serverUrl = this.config.serverUrl;
                if (serverUrl.endsWith('/')) serverUrl = serverUrl.slice(0, -1);
                return serverUrl + path;
            }

            getHeaders() {
                const headers = {
                    'Authorization': this.getAuthHeader()
                };
                if (this.config.proxyUrl) {
                    let serverUrl = this.config.serverUrl;
                    if (serverUrl.endsWith('/')) serverUrl = serverUrl.slice(0, -1);
                    headers['X-Target-Url'] = serverUrl;
                }
                return headers;
            }

            async resolveConflict(local, remote) {
                const strategy = this.config.conflictStrategy;
                if (strategy === 'local-wins') return local;
                if (strategy === 'remote-wins') return remote;
                
                const localTime = new Date(local.lastUpdated || 0).getTime();
                const remoteTime = new Date(remote.lastUpdated || 0).getTime();
                
                return remoteTime > localTime ? remote : local;
            }
            
            updateSyncStatus() {} // Mock
        }

        // æµ‹è¯•æ¡†æ¶
        const tests = [];
        function test(name, fn) { tests.push({ name, fn }); }
        
        function assert(condition, message) {
            if (!condition) throw new Error(message || "Assertion failed");
        }

        function assertEqual(actual, expected, message) {
            if (actual !== expected) throw new Error(`${message || ""} (Expected: ${expected}, Got: ${actual})`);
        }

        // --- æµ‹è¯•ç”¨ä¾‹ ---

        test("é»˜è®¤é…ç½®åŠ è½½", () => {
            localStorage.clear();
            const client = new NutcloudWebDAVClient();
            assert(client.config.serverUrl.includes('jianguoyun'), "é»˜è®¤åŒ…å«åšæœäº‘URL");
            assertEqual(client.config.username, '', "é»˜è®¤ç”¨æˆ·åä¸ºç©º");
        });

        test("é…ç½®ä¿å­˜ä¸åŠ å¯†", () => {
            const client = new NutcloudWebDAVClient();
            client.saveConfig(); // ä½¿ç”¨æ¨¡æ‹ŸDOMä¸­çš„å€¼
            
            const saved = JSON.parse(localStorage.getItem('webdav_config'));
            assertEqual(saved.username, 'test@example.com', "ç”¨æˆ·åä¿å­˜æ­£ç¡®");
            assert(saved.password !== 'password123', "å¯†ç å·²åŠ å¯†");
            assertEqual(atob(saved.password), 'password123', "å¯†ç å¯è§£å¯†");
        });

        test("Auth Header ç”Ÿæˆ", () => {
            const client = new NutcloudWebDAVClient();
            client.saveConfig();
            
            const header = client.getAuthHeader();
            const expected = 'Basic ' + btoa('test@example.com:password123');
            assertEqual(header, expected, "Auth Header ç”Ÿæˆæ­£ç¡®");
        });

        test("URL ç”Ÿæˆ (ç›´è¿æ¨¡å¼)", () => {
            const client = new NutcloudWebDAVClient();
            client.config.serverUrl = 'https://dav.test.com/';
            client.config.proxyUrl = '';
            
            assertEqual(client.getRequestUrl('file.json'), 'https://dav.test.com/file.json', "åŸºæœ¬URLæ‹¼æ¥æ­£ç¡®");
            assertEqual(client.getRequestUrl('/file.json'), 'https://dav.test.com/file.json', "å¤„ç†é‡å¤æ–œæ ");
        });

        test("URL ç”Ÿæˆ (ä»£ç†æ¨¡å¼)", () => {
            const client = new NutcloudWebDAVClient();
            client.config.serverUrl = 'https://dav.test.com/';
            client.config.proxyUrl = 'https://proxy.com/api';
            
            assertEqual(client.getRequestUrl('file.json'), 'https://proxy.com/api/file.json', "ä»£ç†URLä¼˜å…ˆ");
            
            const headers = client.getHeaders();
            assertEqual(headers['X-Target-Url'], 'https://dav.test.com', "åŒ…å«ç›®æ ‡URLå¤´");
        });

        test("å†²çªè§£å†³ (æœ€æ–°ä¼˜å…ˆ)", async () => {
            const client = new NutcloudWebDAVClient();
            client.config.conflictStrategy = 'newest-wins';
            
            const oldData = { lastUpdated: '2023-01-01T00:00:00Z', v: 1 };
            const newData = { lastUpdated: '2023-01-02T00:00:00Z', v: 2 };
            
            const result1 = await client.resolveConflict(oldData, newData);
            assertEqual(result1.v, 2, "åº”é€‰æ‹©è¾ƒæ–°çš„è¿œç¨‹æ•°æ®");
            
            const result2 = await client.resolveConflict(newData, oldData);
            assertEqual(result2.v, 2, "åº”é€‰æ‹©è¾ƒæ–°çš„æœ¬åœ°æ•°æ®");
        });

        test("å†²çªè§£å†³ (æœ¬åœ°ä¼˜å…ˆ)", async () => {
            const client = new NutcloudWebDAVClient();
            client.config.conflictStrategy = 'local-wins';
            
            const local = { v: 'local' };
            const remote = { v: 'remote' };
            
            const result = await client.resolveConflict(local, remote);
            assertEqual(result.v, 'local', "åº”å¼ºåˆ¶é€‰æ‹©æœ¬åœ°æ•°æ®");
        });

        // --- è¿è¡Œæµ‹è¯• ---
        async function runTests() {
            const resultsEl = document.getElementById('test-results');
            const summaryEl = document.getElementById('summary');
            let passed = 0;
            let failed = 0;

            for (const t of tests) {
                const groupEl = document.createElement('div');
                groupEl.className = 'test-group';
                
                try {
                    await t.fn();
                    groupEl.innerHTML = `<div class="test-case"><span>${t.name}</span><span class="pass">âœ… PASS</span></div>`;
                    passed++;
                } catch (e) {
                    console.error(e);
                    groupEl.innerHTML = `<div class="test-case"><span>${t.name}</span><span class="fail">âŒ FAIL: ${e.message}</span></div>`;
                    failed++;
                }
                resultsEl.appendChild(groupEl);
            }

            summaryEl.innerHTML = `
                <h3>æµ‹è¯•æ€»ç»“</h3>
                <p>æ€»è®¡: ${tests.length}</p>
                <p style="color: green">é€šè¿‡: ${passed}</p>
                <p style="color: red">å¤±è´¥: ${failed}</p>
            `;
        }

        runTests();
    </script>
</body>
</html>
