name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
      
    - name: Build project
      run: |
        # 检查必要文件是否存在
        if [ ! -f "ultimate-points-system-fixed.html" ]; then
          echo "Error: ultimate-points-system-fixed.html not found"
          exit 1
        fi
        
        if [ ! -f "index.html" ]; then
          echo "Error: index.html not found"
          exit 1
        fi
        
        if [ ! -f "webdav-test.html" ]; then
          echo "Error: webdav-test.html not found"
          exit 1
        fi
        
        # 验证HTML文件语法
        echo "验证HTML文件完整性..."
        
        # 检查文件大小
        size=$(wc -c < "ultimate-points-system-fixed.html")
        echo "主文件大小: $size bytes"
        
        if [ $size -lt 100000 ]; then
          echo "Warning: 文件大小异常，可能不完整"
        fi
        
        # 检查CORS修复代码是否包含
        echo "检查CORS修复代码..."
        if grep -q "testCORSProxyConnection" ultimate-points-system-fixed.html; then
          echo "✅ CORS代理连接功能已包含"
        else
          echo "❌ CORS代理连接功能缺失"
          exit 1
        fi
        
        if grep -q "connectionMethod" ultimate-points-system-fixed.html; then
          echo "✅ 多重连接策略已实现"
        else
          echo "❌ 多重连接策略缺失"
          exit 1
        fi
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        force_orphan: true
        
    - name: Deploy verification
      run: |
        echo "部署验证完成"
        echo "部署时间: $(date)"
        echo "工作流程: ${{ github.workflow }}"
        echo "提交SHA: ${{ github.sha }}"
        
    - name: Create deployment info
      run: |
        echo "=== 部署信息 ===" > deployment-info.txt
        echo "部署时间: $(date -u)" >> deployment-info.txt
        echo "分支: ${{ github.ref_name }}" >> deployment-info.txt
        echo "提交: ${{ github.sha }}" >> deployment-info.txt
        echo "工作流程: ${{ github.workflow }}" >> deployment-info.txt
        echo "运行ID: ${{ github.run_id }}" >> deployment-info.txt
        echo "构建文件:" >> deployment-info.txt
        echo "- index.html (首页)" >> deployment-info.txt
        echo "- ultimate-points-system-fixed.html (主系统)" >> deployment-info.txt
        echo "- README.md (说明文档)" >> deployment-info.txt